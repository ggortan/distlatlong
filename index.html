<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Mapa Fullscreen - Distâncias</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    .full-height {
      height: 100vh;
    }
    #map {
      height: 100%;
      width: 100%;
    }
    .scroll-column {
      overflow-y: auto;
      height: 100vh;
    }
    textarea {
      resize: vertical;
    }
    #fileInput {
      display: none;
    }
  </style>
</head>
<body>

<div class="container-fluid">
  <div class="row full-height">

    <div class="col-lg-4 col-md-5 bg-light scroll-column d-flex flex-column" style="height: 100vh;">
      <div style="flex-grow: 1; overflow-y: auto;">
        <h4 class="mt-3 mb-3">Distância entre pontos</h4>
        <p class="text-muted small">Formato por linha: <code>lat1 long1 lat2 long2</code></p>
    
        <textarea id="inputCoords" class="form-control mb-3" rows="5">-22.725165 -47.6493269 -22.9056391 -47.059564</textarea>
    
        <button id="calcButton" class="btn btn-primary w-100">Calcular e Exibir no Mapa</button>
    
        <div id="output" class="mt-4">
          <h6>Resultados:</h6>
          <div class="table-responsive">
            <table class="table table-bordered table-sm table-striped">
              <thead class="table-light">
                <tr>
                  <th>#</th>
                  <th>Ponto A (lat, long)</th>
                  <th>Ponto B (lat, long)</th>
                  <th>Distância (m)</th>
                </tr>
              </thead>
              <tbody id="resultsTable"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="mb-3">
        <div class="row g-2">
          <div class="col-6">
            <button id="exportButton" class="btn btn-outline-secondary w-100">
              <i class="bi bi-download"></i> Exportar TXT
            </button>
          </div>
          <div class="col-6">
            <button id="importButton" class="btn btn-outline-secondary w-100">
              <i class="bi bi-upload"></i> Importar TXT
            </button>
          </div>
        </div>
        <input type="file" id="fileInput" accept=".txt" />
      </div>
    
      <footer class="bg-light text-center text-muted py-2 border-top">
           <small>
            Criado por <a href="https://www.linkedin.com/in/gabrielgortan/" target="_blank" rel="noopener noreferrer">Gabriel Gortan</a>
            </small>
      </footer>
    
    </div>

    <div class="col-lg-8 col-md-7 p-0">
      <div id="map"></div>
    </div>

  </div>
</div>

<div class="modal fade" id="alertModal" tabindex="-1" aria-labelledby="alertModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="alertModalLabel">Aviso</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="alertModalBody"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        <button type="button" class="btn btn-primary" id="alertModalConfirm" style="display: none;">Confirmar</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  const map = L.map('map').setView([-22.45, -51.45], 10);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap'
  }).addTo(map);

  const blueIcon = new L.Icon({
    iconUrl: 'https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-2x-blue.png',
    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41]
  });

  const redIcon = new L.Icon({
    iconUrl: 'https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-2x-red.png',
    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41]
  });

  let features = [];

  function showAlert(message, isConfirm = false) {
    document.getElementById('alertModalBody').innerHTML = message;
    const confirmBtn = document.getElementById('alertModalConfirm');
    
    if (isConfirm) {
      confirmBtn.style.display = 'inline-block';
      return new Promise((resolve) => {
        confirmBtn.onclick = () => {
          bootstrap.Modal.getInstance(document.getElementById('alertModal')).hide();
          resolve(true);
        };
        document.querySelector('[data-bs-dismiss="modal"]').onclick = () => {
          resolve(false);
        };
        new bootstrap.Modal(document.getElementById('alertModal')).show();
      });
    } else {
      confirmBtn.style.display = 'none';
      new bootstrap.Modal(document.getElementById('alertModal')).show();
      return Promise.resolve(false);
    }
  }

  document.getElementById('calcButton').addEventListener('click', function () {
    const input = document.getElementById('inputCoords').value.trim();
    const outputTable = document.getElementById('resultsTable');
    outputTable.innerHTML = '';
    features = [];

    const lines = input.split('\n');
    const bounds = [];

    map.eachLayer(layer => {
      if (!(layer instanceof L.TileLayer)) {
        map.removeLayer(layer);
      }
    });

    lines.forEach((line, index) => {
      const parts = line.trim().split(/\s+/);
      if (parts.length !== 4) return;

      const [lat1, long1, lat2, long2] = parts.map(Number);
      if ([lat1, long1, lat2, long2].some(isNaN)) return;

      const pointA = L.latLng(lat1, long1);
      const pointB = L.latLng(lat2, long2);
      const distance = pointA.distanceTo(pointB).toFixed(2);

      const markerA = L.marker(pointA, { icon: blueIcon })
        .addTo(map)
        .bindPopup(`<strong>Ponto A (${index + 1})</strong><br>Lat: ${lat1.toFixed(6)}<br>long: ${long1.toFixed(6)}`);

      const markerB = L.marker(pointB, { icon: redIcon })
        .addTo(map)
        .bindPopup(`<strong>Ponto B (${index + 1})</strong><br>Lat: ${lat2.toFixed(6)}<br>long: ${long2.toFixed(6)}`);

      const linha = L.polyline([pointA, pointB], {
        color: 'green', weight: 3, opacity: 1
      }).addTo(map).bindPopup(`<strong>Distância:</strong> ${distance} metros`);

      bounds.push(pointA, pointB);
      features.push({ markerA, markerB, linha });

      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${index + 1}</td>
        <td>${lat1.toFixed(6)}, ${long1.toFixed(6)}</td>
        <td>${lat2.toFixed(6)}, ${long2.toFixed(6)}</td>
        <td>${distance}</td>
      `;
      row.setAttribute('data-index', index);
      row.style.cursor = 'pointer';
      row.addEventListener('click', () => highlightFeature(index));
      outputTable.appendChild(row);
    });

    if (bounds.length > 0) {
      map.fitBounds(L.latLngBounds(bounds), { padding: [20, 20] });
    }
  });

  function highlightFeature(index) {
    features.forEach((f, i) => {
      const isActive = i === index;
      if (isActive) {
        f.markerA.setOpacity(1);
        f.markerB.setOpacity(1);
        f.linha.setStyle({ opacity: 1, weight: 4 });
        map.fitBounds(f.linha.getBounds(), { padding: [20, 20] });
        f.linha.bringToFront();
        f.markerA.bringToFront();
        f.markerB.bringToFront();
      } else {
        f.markerA.setOpacity(0.3);
        f.markerB.setOpacity(0.3);
        f.linha.setStyle({ opacity: 0.3, weight: 2 });
      }
    });
  }

  document.getElementById('exportButton').addEventListener('click', function () {
    const data = document.getElementById('inputCoords').value.trim();
    if (!data) {
      showAlert('Não há dados para exportar. Adicione coordenadas primeiro.');
      return;
    }
    const blob = new Blob([data], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'coordenadas_distancias.txt';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
  });

  document.getElementById('importButton').addEventListener('click', function () {
    document.getElementById('fileInput').click();
  });

  document.getElementById('fileInput').addEventListener('change', function (event) {
    const file = event.target.files[0];
    if (!file) return;
    if (!file.name.toLowerCase().endsWith('.txt')) {
      showAlert('Por favor, selecione um arquivo TXT.');
      return;
    }
    const reader = new FileReader();
    reader.onload = async function (e) {
      const content = e.target.result;
      const lines = content.trim().split('\n');
      let validLines = 0;
      for (let line of lines) {
        const parts = line.trim().split(/\s+/);
        if (parts.length === 4 && !parts.some(part => isNaN(Number(part)))) {
          validLines++;
        }
      }
      if (validLines === 0) {
        showAlert('O arquivo não contém dados válidos. Cada linha deve ter 4 números (lat1 long1 lat2 long2).');
        return;
      }
      document.getElementById('inputCoords').value = content.trim();
      const shouldCalculate = await showAlert(
        `Arquivo importado com sucesso! ${validLines} linha(s) válida(s) encontrada(s).<br><br>Deseja calcular e exibir no mapa?`, 
        true
      );
      if (shouldCalculate) {
        document.getElementById('calcButton').click();
      }
    };
    reader.onerror = function () {
      showAlert('Erro ao ler o arquivo. Tente novamente.');
    };
    reader.readAsText(file);
    event.target.value = '';
  });
</script>

</body>
</html>
